---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup}
library(infotheo)
library(tidyverse)
library(ggplot2)
library(devtools)
#library(tidyinfostats)
devtools::load_all("..")
set.seed(101)
```

## Mutual information of continuous versus discrete disctirbutions

Assume a continuous distribution

$$X=Y$$

```{r}
hb = ConditionalDistribution$new()
hb$withDistribution(0.75, LogNormalDistribution$new(mode=12,sd=2), "asymptomatic")
hb$withDistribution(0.25, LogNormalDistribution$new(mode=8,sd=3), "tired")
hb$withDistribution(0.25, LogNormalDistribution$new(mode=4,sd=5), "unwell")
hb$plot(0,20)

```

```{r}
k = ConditionalDistribution$new()
k$withDistribution(0.125, LogNormalDistribution$new(mode=1,sd=0.5), "unwell")
k$withDistribution(0.75, LogNormalDistribution$new(mode=2,sd=1), "asymptomatic")
k$withDistribution(0.125, LogNormalDistribution$new(mode=8,sd=3), "tired")

tibble(measure = c("Mean","Variance","Mutual Information"),
hb = c(hb$theoreticalMean(),hb$theoreticalVariance(), hb$theoreticalMI()),
k = c(k$theoreticalMean(),k$theoreticalVariance(),k$theoreticalMI()))
```

```{r}
testData = k$sample(500) %>% mutate(test="k") %>% bind_rows(
  hb$sample(1000) %>% mutate(test="hb")) %>% rename(outcome=y, value=x)

ggplot(testData, aes(fill=outcome, x=value))+geom_histogram(position="dodge", bins=50)+facet_grid(cols=vars(test))
```

```{r}

testData %>% group_by(test) %>% tidyinfostats::calculateDiscreteContinuousMI(outcome, value, method = "KWindow") %>% rename(I.win=I) %>% left_join(
testData %>% group_by(test) %>% tidyinfostats::calculateDiscreteContinuousMI(outcome, value, method = "SGolay") %>% rename(I.sg=I), by="test") %>% left_join(
testData %>% group_by(test) %>% tidyinfostats::calculateDiscreteContinuousMI(outcome, value, method = "Discrete") %>% rename(I.disc=I), by="test") %>% left_join(
tibble(test=c("hb","k"),I.theory = c(hb$theoreticalMI(),k$theoreticalMI())), by="test"
)
```

mus = c(10,10)
sigmas = c(2,2)
counts = c(75,75)
theoreticalMI(mus,sigmas,counts)
theoreticalMI2(mus,sigmas,counts)

mus = c(8,12)
sigmas = c(4,3)
counts = c(500,500)
theoreticalMI(mus,sigmas,counts)
theoreticalMI2(mus,sigmas,counts)

mus = c(1,3,8)
sigmas = c(1,3,5)
counts = c(500,500,250)
theoreticalMI(mus,sigmas,counts)
df = generateDataSet(mus,sigmas,counts)
calculateMultiClassContinuousMI_SG(df, outcome, value,10)
calculateMultiClassContinuousMI_KNN(df, outcome, value,2)

mus = c(1,8)
sigmas = c(1,1)
counts = c(50,50)
theoreticalMI(mus,sigmas,counts)
theoreticalMI2(mus,sigmas,counts)

mus = c(1,3,8)
sigmas = c(1,3,5)
counts = c(500,500,250)
plotTheoreticalMI(mus,sigmas,counts)
df = generateDataSet(mus,sigmas,counts)
ggplot(df)+geom_histogram(aes(fill=as.factor(label),x=value),position="dodge")+
		labs(x="y",y="count",fill="x")
th = theoreticalMI(mus,sigmas,counts)
kout = NULL
for (i in seq(1,100)) {
	# i = 1
	df = generateDataSet(mus,sigmas,counts)
	k = c(5,7,10,15,20,30,40)
	
	kresult = sapply(k, function(k2) (calculateMultiClassContinuousMI_SG(df, outcome, value, k2) %>% pull(I)))
	kresult = data.frame(
			method = rep("SG",length(k)),
			param = rep("filter width",length(k)),
			test = rep(i,length(k)), 
			value = k, 
			result = kresult,
			theoretical = rep(th,length(k),
					stringsAsFactors=FALSE
			)
	)
	kout = kout %>% bind_rows(kresult)
	
	w = c(1:10)
	
	kresult2 = sapply(w, function(k2) (calculateMultiClassContinuousMI_KNN(df, outcome, value, k2) %>% pull(I)))
	kresult2 = data.frame(
			method = rep("KNN",length(w)),
			param = rep("knn window",length(w)),
			test = rep(i,length(w)), 
			value = w, 
			result = kresult2,
			theoretical = rep(th,length(w)),
			stringsAsFactors=FALSE
	)
	kout = kout %>% bind_rows(kresult2)
	
	# names(kresult) <- k
	binPow = seq(0.1,1,0.1)
	binSize = floor(sum(counts)^binPow)
	nresult = sapply(binSize, function(n2) {
				ref = df %>% select(outcome,value) %>% discretize(n=sum(counts)/n2)
				mutinformation(ref$outcome, ref$value)
			})
	
	nresult = data.frame(
			method = rep("discrete",length(n)),
			param = rep("bins",length(n)),
			test = rep(i,length(n)), 
			value = binSize, 
			result = nresult,
			theoretical = rep(th,length(n)),
			stringsAsFactors=FALSE
	)
	# names(nresult) <- n
	
	kout = kout %>% bind_rows(nresult)
}



kout = kout %>% group_by(method,value) %>% mutate(mean = mean(result),stdev = sd(result))

ggplot(kout)+geom_boxplot(aes(y=result,fill = as.factor(value)))+expand_limits(y=0)+geom_hline(yintercept=th)+facet_grid(cols=vars(method))

ggplot(kout %>% filter(method=="discrete"), aes(x=value))+
		geom_ribbon(aes(ymin=mean-1.96*stdev,ymax=mean+1.96*stdev), fill = "grey70")+
		geom_point(aes(y=mean))+
		geom_line(aes(y=mean))+
		expand_limits(y=0)+
		geom_hline(yintercept=th)
#ggplot(kout %>% filter(method=="KNN"))+geom_boxplot(aes(group=k,y=result,fill = method))+ylim(-2,2)

```